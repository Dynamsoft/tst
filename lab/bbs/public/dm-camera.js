!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).DMCamera={})}(this,(function(e){"use strict";const t=[["\ud2b8\ub9ac\ud50c","\u4e09\u955c\u5934","\u4e09\u93e1\u982d","\u30c8\u30ea\u30d7\u30eb","\u0e2a\u0e32\u0e21","\u091f\u094d\u0930\u093f\u092a\u0932","\u062b\u0644\u0627\u062b\u064a\u0629","\u05de\u05e9\u05d5\u05dc\u05e9\u05ea","\u04af\u0448\u0442\u0456\u043a","\u0442\u0440\u043e\u0439\u043d\u0430\u044f","\u0442\u0440\u043e\u0439\u043d\u0430","\u043f\u043e\u0442\u0440\u043e\u0454\u043d\u0430","\u03c4\u03c1\u03b9\u03c0\u03bb\u03ae","\u00fc\u00e7l\u00fc","tr\u00f3jobiektywowy","trostruka","trojn\u00fd","trojit\u00e1","trippelt","trippel","tripl\u0103","triple","tripla","tiga","kolmois","ba camera"],["\ub4c0\uc5bc \uc640\uc774\ub4dc","\u96d9\u5ee3\u89d2","\u53cc\u5e7f\u89d2","\u30c7\u30e5\u30a2\u30eb\u5e83\u89d2","\u0e04\u0e39\u0e48\u0e14\u0e49\u0e32\u0e19\u0e2b\u0e25\u0e31\u0e07\u0e21\u0e38\u0e21\u0e01\u0e27\u0e49\u0e32\u0e07","\u0921\u094d\u092f\u0941\u0905\u0932 \u0935\u093e\u0907\u0921","\u0645\u0632\u062f\u0648\u062c\u0629 \u0639\u0631\u064a\u0636\u0629","\u05db\u05e4\u05d5\u05dc\u05d4 \u05e8\u05d7\u05d1\u05d4","\u049b\u043e\u0441 \u043a\u0435\u04a3 \u0431\u04b1\u0440\u044b\u0448\u0442\u044b","\u0437\u0434\u0432\u043e\u0454\u043d\u0430 \u0448\u0438\u0440\u043e\u043a\u043e\u043a\u0443\u0442\u043d\u0430","\u0434\u0432\u043e\u0439\u043d\u0430\u044f \u0448\u0438\u0440\u043e\u043a\u043e\u0443\u0433\u043e\u043b\u044c\u043d\u0430\u044f","\u0434\u0432\u043e\u0439\u043d\u0430 \u0448\u0438\u0440\u043e\u043a\u043e\u044a\u0433\u044a\u043b\u043d\u0430","\u03b4\u03b9\u03c0\u03bb\u03ae \u03b5\u03c5\u03c1\u03b5\u03af\u03b1","\u00e7ift geni\u015f","laajakulmainen kaksois","k\u00e9p r\u1ed9ng m\u1eb7t sau","kett\u0151s, sz\u00e9les l\u00e1t\u00f3sz\u00f6g\u0171","grande angular dupla","ganda","dwuobiektywowy","dwikamera","dvostruka \u0161iroka","du\u00e1ln\u00ed \u0161iroko\u00fahl\u00fd","du\u00e1lna \u0161irokouhl\u00e1","dupla grande-angular","dubl\u0103","dubbel vidvinkel","dual-weitwinkel","dual wide","dual con gran angular","dual","double","doppia con grandangolo","doble","dobbelt vidvinkelkamera"],["camera2 0,"],["\ud6c4","\u80cc\u9762","\u80cc\u7f6e","\u5f8c\u9762","\u5f8c\u7f6e","\u540e\u9762","\u540e\u7f6e","\u0e32\u0e19\u0e2b\u0e25\u0e31\u0e07","\u0e2b\u0e25\u0e31\u0e07","\u092c\u0948\u0915","\u062e\u0644\u0641\u064a\u0629","\u05d0\u05d7\u05d5\u05e8\u05d9\u05ea","\u0437\u0430\u0434\u043d\u044f\u044f","\u0437\u0430\u0434\u043d\u044f","\u0437\u0430\u0434\u043d\u0435\u0439","\u0437\u0430\u0434\u043d\u0430","\u03c0\u03af\u03c3\u03c9","zadn\u00ed","zadn\u00e1","tylny","tr\u00e1s","trasera","traseira","taka","stra\u017enja","spate","sau","r\u00fcck","rear","posteriore","posterior","h\u00e1ts\u00f3","darrere","belakang","baksidan","bakre","bak","bagside","back","a\u0440\u0442\u049b\u044b","arri\u00e8re","arka","achterzijde"]],i=(e,t)=>{const{inlineScript2Blob:i}=t||{},o=document.createElement("script");e.textContent&&(i&&!e.src?(o.src=URL.createObjectURL(new Blob([e.textContent],{type:"text/javascript"})),o.addEventListener("load",(()=>URL.revokeObjectURL(o.src)))):o.textContent=e.textContent);for(let t of e.attributes)o.setAttribute(t.name,t.value);return o},o=/<style>([\s\S]*?)<\/style>/g,s=/style="([\s\S]*?)"/g,n=(e,t)=>{const{inlineScript2Blob:n,insertInternalCss2ExistedSheet:a}=t||{};if(a){let t,i;for(let e=document.styleSheets.length-1;e>=0;--e){const o=document.styleSheets[e];try{i=o.cssRules,t=o;break}catch(e){}}t&&(e=e.replace(o,((e,o,s,n)=>{let a=o.split("}");const r=a.length-1;let c=[],h=null,d=0;for(let e=0;e<r;++e){let t=0;for(;-1!==(t=a[e].indexOf("{",t));)d+=1,t+=1;if(h)1===d?(c.push(h+a[e]+"}"),h=null,d=0):(h+=a[e]+"}",--d);else{if(d<1)throw new Error("invalid style");1===d?(c.push(a[e].trimStart()+"}"),d=0):(h=a[e].trimStart()+"}",--d)}}if(h||d)throw new Error("invalid style");for(let e of c)t.insertRule(e,i.length);return""})))}const r=[];e=e.replace(s,((e,t,i,o)=>(r.push(t),"hasStyle")));const c=document.createElement("div");c.insertAdjacentHTML("beforeend",e),c.normalize();const h=c.querySelectorAll("[hasStyle]");for(let e=0;e<r.length;e++){const t=r[e],i=h[e];if(i instanceof HTMLElement){i.removeAttribute("hasStyle");const e=t.split(";");for(let t of e){const e=t.split(":");i.style[e[0]]=e[1]}}}let d;1===c.childNodes.length&&c.firstChild instanceof HTMLTemplateElement?d=c.firstChild.content:(d=new DocumentFragment,d.append(...c.childNodes));let l=1===d.childNodes.length?d.firstChild:d;if(l instanceof HTMLScriptElement)l=i(l,{inlineScript2Blob:n});else if(l instanceof DocumentFragment||l instanceof Element)for(let e of l.querySelectorAll("script"))e.replaceWith(i(e,{inlineScript2Blob:n}));return l},a=e=>e&&"object"==typeof e&&"function"==typeof e.then,r=(async()=>{})().constructor;class c extends r{get status(){return this._s}get isPending(){return"pending"===this._s}get isFulfilled(){return"fulfilled"===this._s}get isRejected(){return"rejected"===this._s}get task(){return this._task}set task(e){let t;this._task=e,a(e)?t=e:"function"==typeof e&&(t=new r(e)),t&&(async()=>{try{const i=await t;e===this._task&&this.resolve(i)}catch(t){e===this._task&&this.reject(t)}})()}get isEmpty(){return null==this._task}constructor(e){let t,i;super(((e,o)=>{t=e,i=o})),this._s="pending",this.resolve=e=>{this.isPending&&(a(e)?this.task=e:(this._s="fulfilled",t(e)))},this.reject=e=>{this.isPending&&(this._s="rejected",i(e))},this.task=e}}const h={width:1280,height:720},d=function(){const e=this,t=MediaDeviceInfo.prototype.toJSON.apply(e);return t.trackLabel=e.trackLabel,t.capabilities=e.capabilities,t};class l{static _cameraNameMatcher=t;static _mapDeviceInfo;_coreShell;_video;_coreInnerLayer;_coreOuterLayer;_regionBoxWrapper;_regionBoxMask;_regionBoxBorder;_objectFit="cover";_uiInlineScript2Blob=!0;_uiInternalCss2ExistedSheet=!0;_ui;_pOpen;_paused=!1;_shouldClose=!1;_cameraChangedWhenPaused=!1;_resolutionChangedWhenPaused=!1;_requestedCamera="back";_requestedResolution=h;_regionBox={unit:"view-size",center:{x:0,y:0},maskStyle:{background:"rgba(0, 0, 0, 0.5)"},borderStyle:{border:"1px solid #00ff7f"}};_eventListeners={};static _arrConstructors=[];static _arrOnOpen=[];static _arrOnClose=[];constructor(){const e=this._coreShell=document.createElement("div");Object.assign(e.style,{width:"100%",height:"100%",minWidth:"100px",minHeight:"100px",backgroundColor:"black",display:"flex",justifyContent:"center",alignItems:"center",overflow:"hidden",position:"relative"});const t=this._coreOuterLayer=document.createElement("div");Object.assign(t.style,{width:"auto",height:"100%",minWidth:"100px",minHeight:"100px",aspectRatio:"1",flex:"none",position:"relative",overflow:"hidden"});const i=this._coreInnerLayer=document.createElement("div");Object.assign(i.style,{width:"100%",height:"100%",position:"relative",transformOrigin:"center"});const o=this._video=document.createElement("video");Object.assign(o.style,{width:"100%",height:"100%",position:"absolute",left:"0",top:"0",objectFit:"fill"}),o.muted=!0,o.playsInline=!0,i.append(o),t.append(i),e.append(t);new ResizeObserver((()=>{this._updateObjectFit()})).observe(e);for(let e of l._arrConstructors)e.call(this)}_updateObjectFit(){if("opened"!==this.status&&"paused"!==this.status)return;const e=this._video,t=this._coreOuterLayer.style,i=this._regionBoxWrapper?.style;if("fill"===this._objectFit)return"100%"!==t.width&&(t.width="100%"),"100%"!==t.height&&(t.height="100%"),void(i&&("100%"!==i.width&&(i.width="100%"),"100%"!==i.height&&(i.height="100%")));const{width:o,height:s}=this._coreShell.getBoundingClientRect(),n=`${e.videoWidth} / ${e.videoHeight}`;n!=t.aspectRatio&&(t.aspectRatio=n),i&&n!=i.aspectRatio&&(i.aspectRatio=n);let a=!1;o/s>e.videoWidth/e.videoHeight&&(a=!a),"cover"===this._objectFit&&(a=!a);const r=i&&"contain"===this._objectFit,c=i&&"cover"===this._objectFit;a?("auto"!=t.width&&(t.width="auto"),"100%"!=t.height&&(t.height="100%"),r&&("auto"!=i.width&&(i.width="auto"),"100%"!=i.height&&(i.height="100%"))):("100%"!=t.width&&(t.width="100%"),"auto"!=t.height&&(t.height="auto"),r&&("100%"!=i.width&&(i.width="100%"),"auto"!=i.height&&(i.height="auto"))),c&&("100%"!==i.width&&(i.width="100%"),"100%"!==i.height&&(i.height="100%"))}get video(){return this._video}get track(){return this._video?.srcObject?.getTracks()[0]}get objectFit(){return this._objectFit}set objectFit(e){this._objectFit=e,this._updateObjectFit()}get ui(){return this._ui||this._coreShell}set ui(e){if(!e)return void(this._ui=void 0);if(e instanceof HTMLElement&&(e.contains(this._coreShell)||e.shadowRoot?.contains(this._coreShell)))return void(this._ui=e);if("string"==typeof e){if(!e.trim().startsWith("<"))throw Error("Invalid html string.");e=n(e,{inlineScript2Blob:this._uiInlineScript2Blob,insertInternalCss2ExistedSheet:this._uiInternalCss2ExistedSheet})}let t;if(e instanceof HTMLElement)t=e;else{if(!(e instanceof DocumentFragment))throw Error("Seems no HTMLElement.");t=document.createElement("div"),t.append(e)}const i="dm-camera-core-container",o=t.classList.contains(i)?t:t.querySelector(`.${i}`);if(!o)throw Error(`Can't find element with class \`${i}\`.`);this._ui=t;for(let e of t.querySelectorAll("script"))e.currentDMCamera=this;o.append(this._coreShell)}get status(){return this._pOpen?this._pOpen.isPending?this._shouldClose?"closing":"opening":this._paused?"paused":"opened":"closed"}get requestedCamera(){return this._requestedCamera}get requestedResolution(){return this._requestedResolution}get currentCamera(){if("opened"!==this.status&&"paused"!==this.status)throw Error("Camera is not opened");return l._mapDeviceInfo?.[this.track?.getSettings()?.deviceId]}get currentResolution(){if("opened"!==this.status&&"paused"!==this.status)throw Error("Camera is not opened");let e=this.track?.getSettings();return{width:e?.width,height:e?.height}}get regionBox(){return this._regionBox}onOpened;static async hasCamera(){return!!(await navigator.mediaDevices.enumerateDevices()).filter((e=>"videoinput"===e.kind)).length}static async hasMacroCamera(){return!!(await l.getDeviceInfos()).find((e=>e.capabilities?.facingMode?.includes("environment")&&e.capabilities?.focusDistance?.min<.061))}static async getDeviceInfos(){let e=(await navigator.mediaDevices.enumerateDevices()).filter((e=>"videoinput"===e.kind));if(!e.length)return[];if(e.some((e=>!e.deviceId))){let t;try{t=await navigator.mediaDevices.getUserMedia({video:!0,audio:!1}),e=(await navigator.mediaDevices.enumerateDevices()).filter((e=>"videoinput"===e.kind)),e.some((e=>!e.deviceId))&&console.warn("Some camera does not have deviceId.")}catch(e){console.warn("Failed to get device ID by opening camera.",e)}if(t){const i=t.getTracks().filter((e=>"video"===e.kind))[0],o=i.getSettings().deviceId;let s=e.find((e=>e.deviceId===o));s?(s.trackLabel=i.label,s.capabilities=i.getCapabilities?.(),s.toJSON=d):console.warn("Can't find current device by `track.getSettings().deviceId`."),t.getTracks().forEach((e=>e.stop()))}}await l._setCapabilities(e);const t=e.reduce(((e,t)=>(e[t.deviceId]=t,e)),{});return l._mapDeviceInfo=t,[...e]}static async _setCapabilities(e){for(let t of e){if(!t.deviceId)continue;if(d===t.toJSON)continue;let e=l._mapDeviceInfo?.[t.deviceId];if(e)t.trackLabel=e.trackLabel,t.capabilities=e.capabilities;else try{const e=await navigator.mediaDevices.getUserMedia({video:{deviceId:t.deviceId},audio:!1}),i=e.getTracks().filter((e=>"video"===e.kind))[0];t.trackLabel=i.label,t.capabilities=i.getCapabilities?.(),e.getTracks().forEach((e=>e.stop()))}catch(e){console.warn("Failed to get `trackLabel` and `capabilities`, by opening camera.",e)}t.toJSON=d}}async open(){if("opened"!==this.status)if("closed"===this.status||"paused"===this.status)try{if("paused"===this.status&&this._cameraChangedWhenPaused&&(await this.close(),this._cameraChangedWhenPaused=!1),"closed"===this.status){if(this._pOpen=new c,"customized-video"!==this._requestedCamera){let e;if("string"==typeof this._requestedCamera){switch(this._requestedCamera){case"front":e={facingMode:"user"};break;case"quick-back":e={facingMode:"environment"};break;case"back":{const t=await l.getDeviceInfos();if(!t.length)throw Error("No camera found.");for(let i of l._cameraNameMatcher){for(let o of t){const t=(o.trackLabel||o.label)?.toLowerCase();for(let s of i)if(t.includes(s)){e={deviceId:o.deviceId};break}if(e)break}if(e)break}if(e)break;t.reverse();for(let i of t)if(i.capabilities?.facingMode?.includes("environment")){e={deviceId:i.deviceId};break}e={deviceId:t[0].deviceId};break}case"macro-back":{const t=await l.getDeviceInfos();if(!t.length)throw Error("No camera found.");const i=t.reduce(((e,t)=>t?.capabilities?.facingMode?.includes("environment")&&(!e||e?.capabilities?.focusDistance?.min||t?.capabilities?.focusDistance?.min<e?.capabilities?.focusDistance?.min)?t:e));e={deviceId:i?.deviceId||t[t.length-1].deviceId};break}default:throw Error(`Unknown camera preset: ${this._requestedCamera}`)}this._requestedCamera=e}else e=this._requestedCamera;const t={video:Object.assign({},e,this._requestedResolution),audio:!1},i=await navigator.mediaDevices.getUserMedia(t);if("closing"===this.status)throw Error("Camera closed.");this._video.srcObject=i}if(await this._video.play(),"closing"===this.status)throw Error("Camera closed.");this._pOpen.resolve();try{this._updateObjectFit()}catch(e){console.error(e)}try{this._updateCanvasSize()}catch(e){console.error(e)}}else{if(this._pOpen=new c,this.track.enabled=!0,await this._video.play(),"closing"===this.status)throw Error("Camera closed.");if(this._paused=!1,this._pOpen.resolve(),this._resolutionChangedWhenPaused){try{this._updateObjectFit()}catch(e){console.error(e)}try{this._updateCanvasSize()}catch(e){console.error(e)}this._resolutionChangedWhenPaused=!1}}for(let e of l._arrOnOpen)e.call(this);this._callOpenedListeners()}catch(e){this.track?.stop(),this._video.srcObject=null;const t=this._pOpen;throw this._pOpen=null,this._shouldClose=!1,t.reject(),Error(`Error opening camera: ${e?.message}`,{cause:e})}else{if("opening"!==this.status&&"closing"!==this.status)throw Error("Never");await this._pOpen}}async pause(){try{await this._pOpen}catch(e){}"opened"===this.status&&(this.track.enabled=!1,this._video.pause(),this._paused=!0)}async close(){if("closed"!==this.status)if("opening"===this.status&&(this._shouldClose=!0),"closing"!==this.status){this.track.stop(),this._video.srcObject=null,this._pOpen=null,this._paused=!1;for(let e of l._arrOnClose)e.call(this)}else try{await this._pOpen}catch(e){}}async requestCamera(e){"string"==typeof e?u.includes(e)?this._requestedCamera=e:this._requestedCamera={deviceId:e}:e?"videoinput"===e.kind?e.deviceId?this._requestedCamera={deviceId:e.deviceId}:this._requestedCamera="back":this._requestedCamera=JSON.parse(JSON.stringify(e)):null===e?this._requestedCamera=null:void 0===e&&(this._requestedCamera="back"),"opened"===this.status?(await this.close(),await this.open()):"paused"===this.status&&(this._cameraChangedWhenPaused=!0)}async requestResolution(e,t){let i={};if("number"==typeof e?(i.width=e,"number"==typeof t&&(i.height=t)):Array.isArray(e)?(e[0]&&(i.width=e[0]),e[1]&&(i.height=e[1])):e?((e=JSON.parse(JSON.stringify(e))).width&&(i.width=e.width),e.height&&(i.height=e.height),e.aspectRatio&&(i.aspectRatio=e.aspectRatio)):null===e?i=null:void 0===e&&(i=h),this._requestedResolution=i,"opened"===this.status){await this.track.applyConstraints({...i});try{this._updateObjectFit()}catch(e){console.error(e)}try{this._updateCanvasSize()}catch(e){console.error(e)}this._callOpenedListeners()}else"paused"===this.status&&(this._resolutionChangedWhenPaused=!0,await this.track.applyConstraints({...i}))}getFrame(e){if("opened"!==this.status&&"paused"!==this.status)throw Error("Camera is not opened");let{x:t=0,y:i=0,width:o=this._video.videoWidth,height:s=this._video.videoHeight,reusedContext:n}=e||{};o=Math.round(o+t)-Math.round(t),s=Math.round(s+i)-Math.round(i),t=Math.round(t),i=Math.round(i);const a=n?.canvas||document.createElement("canvas");a.width!=o&&(a.width=o),a.height!=s&&(a.height=s);return(n||a.getContext("2d")).drawImage(this._video,t,i,o,s,0,0,o,s),a}setRegionBox(e){if(!(e=Object.assign(this._regionBox,e)).width||!e.height)return this._regionBoxWrapper?.remove(),this._regionBoxWrapper=null,this._regionBoxMask=null,void(this._regionBoxBorder=null);this._regionBoxWrapper||(this._regionBoxWrapper=document.createElement("div"),Object.assign(this._regionBoxWrapper.style,{width:"auto",height:"100%",maxWidth:"100%",maxHeight:"100%",minWidth:"100px",minHeight:"100px",aspectRatio:"1",flex:"none",position:"absolute",display:"flex",alignItems:"center",justifyContent:"center",overflow:"hidden",containerType:"size"}),this._regionBoxMask=document.createElement("div"),Object.assign(this._regionBoxMask.style,{width:"100%",height:"100%",flex:"none"}),this._regionBoxWrapper.append(this._regionBoxMask),this._regionBoxBorder=document.createElement("div"),Object.assign(this._regionBoxBorder.style,{flex:"none",boxSizing:"content-box",position:"absolute"}),this._regionBoxWrapper.append(this._regionBoxBorder),this._coreShell.append(this._regionBoxWrapper)),e.innerUi instanceof HTMLElement?e.innerUi.parentElement!==this._regionBoxBorder&&this._regionBoxBorder.append(e.innerUi):"string"==typeof e.innerUi?this._regionBoxBorder.append(n(e.innerUi)):this._regionBoxBorder.innerHTML="";let t=100*e.center.y-50*e.height+50+"%",i=100*e.center.x+50*e.width+50+"%",o=100*e.center.y+50*e.height+50+"%",s=100*e.center.x-50*e.width+50+"%";Object.assign(this._regionBoxMask.style,{clipPath:`polygon(0% 0%, 100% 0%, 100% 100%, 0% 100%, 0% 0%, ${s} ${t}, ${s} ${o}, ${i} ${o}, ${i} ${t}, ${s} ${t})`}),"view-min"===e.unit&&(t=`calc(${100*e.center.y+50}% + max(-${50*e.height}cqmin, -${50*e.height}cqmax))`,i=`calc(${100*e.center.x+50}% + ${50*e.width}cqmin)`,o=`calc(${100*e.center.y+50}% + ${50*e.height}cqmin)`,s=`calc(${100*e.center.x+50}% + max(-${50*e.width}cqmin, -${50*e.width}cqmax))`,Object.assign(this._regionBoxMask.style,{clipPath:`polygon(0% 0%, 100% 0%, 100% 100%, 0% 100%, 0% 0%, ${s} ${t}, ${s} ${o}, ${i} ${o}, ${i} ${t}, ${s} ${t})`})),Object.assign(this._regionBoxMask.style,{...e.maskStyle}),Object.assign(this._regionBoxBorder.style,{width:100*e.width+"%",height:100*e.height+"%"}),"view-min"===e.unit&&Object.assign(this._regionBoxBorder.style,{width:100*e.width+"cqmin",height:100*e.height+"cqmin"}),Object.assign(this._regionBoxBorder.style,{...e.borderStyle}),this._updateObjectFit()}addCanvas(){const e=document.createElement("canvas");return Object.assign(e.style,{position:"absolute",left:0,top:0,width:"100%",height:"100%"}),"opened"!==this.status&&"paused"!==this.status||(e.width=this._video.videoWidth,e.height=this._video.videoHeight),this._video.parentElement.append(e),e}_updateCanvasSize(){if("opened"!==this.status&&"paused"!==this.status)return;const e=this._video;this._video.parentElement.querySelectorAll("canvas").forEach((t=>{t.width!==e.videoWidth&&(t.width=e.videoWidth),t.height!==e.videoHeight&&(t.height=e.videoHeight)}))}addEventListener(e,t){(this._eventListeners[e]??=new Set).add(t)}removeEventListener(e,t){this._eventListeners[e]?.delete(t)}_callOpenedListeners(){try{this.onOpened?.(this)}catch(e){console.error(e)}this._eventListeners.opened?.forEach((e=>{try{e(this)}catch(e){console.error(e)}}))}videoXY2AbsoluteLT(e){const t=this._video,i=t.getBoundingClientRect(),o=getComputedStyle(document.body);if("static"===o.position){const o=document.documentElement.getBoundingClientRect();return e.map((e=>({left:(this._isMirrored?t.videoWidth-e.x:e.x)/t.videoWidth*i.width+i.x-o.x,top:e.y/t.videoHeight*i.height+i.y-o.y})))}{const s=document.body.getBoundingClientRect(),n=parseFloat(o.borderLeftWidth),a=parseFloat(o.borderTopWidth);return e.map((e=>({left:(this._isMirrored?t.videoWidth-e.x:e.x)/t.videoWidth*i.width+i.x-s.x-n,top:e.y/t.videoHeight*i.height+i.y-s.y-a})))}}videoXY2FixedLT(e){const t=this._video,i=t.getBoundingClientRect();return e.map((e=>({left:(this._isMirrored?t.videoWidth-e.x:e.x)/t.videoWidth*i.width+i.x,top:e.y/t.videoHeight*i.height+i.y})))}getVisibleAreaInVideoXY(e){const{isConsiderRegionBox:t=!1,rounded:i=!1}=e||{};let o;if(t&&this._regionBoxBorder){const e=this._regionBoxBorder.getBoundingClientRect();o={x:e.x,y:e.y,width:e.width,height:e.height};const t=getComputedStyle(this._regionBoxBorder),i=parseFloat(t.borderLeftWidth),s=parseFloat(t.borderTopWidth),n=parseFloat(t.borderRightWidth),a=parseFloat(t.borderBottomWidth);o.x+=i,o.y+=s,o.width-=i+n,o.height-=s+a}else{const e=this._coreShell.getBoundingClientRect();o={x:e.x,y:e.y,width:e.width,height:e.height}}const s=this._video.getBoundingClientRect(),n={x:(o.x-s.x)/s.width,y:(o.y-s.y)/s.height,width:o.width/s.width,height:o.height/s.height};n.x<0&&(n.width+=n.x,n.x=0),n.x>1&&(n.width-=n.x-1,n.x=1),n.y<0&&(n.height+=n.y,n.y=0),n.y>1&&(n.height-=n.y-1,n.y=1),n.x+n.width>1&&(n.width=1-n.x),n.x+n.width<0&&(n.width=-n.x),n.y+n.height>1&&(n.height=1-n.y),n.y+n.height<0&&(n.height=-n.y);const a=this._video.videoWidth,r=this._video.videoHeight;let c=(this.isMirrored?1-n.x-n.width:n.x)*a,h=n.y*r,d=n.width*a,l=n.height*r;return i&&(d=Math.round(d+c)-Math.round(c),l=Math.round(l+h)-Math.round(h),c=Math.round(c),h=Math.round(h)),{x:c,y:h,width:d,height:l}}}const u=["back","front","macro-back","quick-back","customized-video"];l._arrConstructors.push((function(){const e=this;e._softZoom={zoom:1,center:{x:0,y:0}},e.maxZoom4GestureWheel=20,e._lastZoomTime=-1/0,e._mapZoomTouchs=new Map,e.enableGestureZoom=!0,e.enableWheelZoom=!0})),Object.defineProperty(l.prototype,"softZoom",{get(){return this._softZoom}}),Object.defineProperty(l.prototype,"isMirrored",{get(){return this._isMirrored},set(e){const t=this;t._isMirrored=e,t.setSoftZoom(t.softZoom.zoom,{center:t.softZoom.center})}}),Object.defineProperty(l.prototype,"enableGestureZoom",{get(){return!!this._gestureZoomListener},set(e){const t=this;e?t._gestureZoomListener||(t._gestureZoomListener=e=>{t._changeZoomByTouch(e)},t._coreShell.addEventListener("touchstart",t._gestureZoomListener),t._coreShell.addEventListener("touchmove",t._gestureZoomListener),t._coreShell.addEventListener("touchend",t._gestureZoomListener),t._coreShell.addEventListener("touchcancel",t._gestureZoomListener)):t._gestureZoomListener&&(t._coreShell.removeEventListener("touchstart",t._gestureZoomListener),t._coreShell.removeEventListener("touchmove",t._gestureZoomListener),t._coreShell.removeEventListener("touchend",t._gestureZoomListener),t._coreShell.removeEventListener("touchcancel",t._gestureZoomListener),t._gestureZoomListener=null)}}),Object.defineProperty(l.prototype,"enableWheelZoom",{get(){return!!this._wheelZoomListener},set(e){const t=this;e?t._wheelZoomListener||(t._wheelZoomListener=e=>{t._changeZoomByWheel(e)},t._coreShell.addEventListener("wheel",t._wheelZoomListener)):t._wheelZoomListener&&(t._coreShell.removeEventListener("wheel",t._wheelZoomListener),t._wheelZoomListener=null)}}),l.prototype.getZoomRange=function(){if("opened"!==this.status)throw Error("Camera is not opened");return this.track.getCapabilities?.()?.zoom},l.prototype.setZoom=async function(e){if("opened"!==this.status)throw Error("Camera is not opened");await this.track.applyConstraints({advanced:[{zoom:e}]})},l.prototype.setSoftZoom=function(e,t){const i=this;let{center:o,limit:s}=t||{},{x:n=0,y:a=0}=o||{};s&&e<1&&(e=1);let r=i._isMirrored?`scale(${-e},${e})`:`scale(${e})`;if(o){if(s){const t=.5-.5/e;n<-t?n=-t:n>t&&(n=t),a<-t?a=-t:a>t&&(a=t)}r+=` translate(${n*=-100}%, ${a*=-100}%)`}i._softZoom={zoom:e,center:{x:n,y:a}},i._coreInnerLayer.style.transform=r},l.prototype._changeZoomByWheel=function(e){const t=this,i=Date.now();let o=t._softZoom.zoom,s=o-e.deltaY/200;s>t.maxZoom4GestureWheel&&(s=t.maxZoom4GestureWheel),s<1&&(s=1),s!==o&&(t.setSoftZoom(s,{center:t._softZoom.center,limit:!0}),t._lastZoomTime=i,e.preventDefault(),t._eventListeners.zoom?.forEach((e=>{try{e(JSON.parse(JSON.stringify(t._softZoom)),t)}catch(e){console.error(e)}})))},l.prototype._changeZoomByTouch=function(e){const t=this;for(e.touches.length>=2&&"touchmove"==e.type&&e.preventDefault();e.changedTouches.length>1&&2==e.touches.length;){let i=Date.now();if(i-t._lastZoomTime<100)return;let o=e.touches[0],s=e.touches[1],n=t._mapZoomTouchs.get(o.identifier),a=t._mapZoomTouchs.get(s.identifier);if(!n||!a)break;let r=Math.pow(Math.pow(n.x-a.x,2)+Math.pow(n.y-a.y,2),.5),c=Math.pow(Math.pow(o.clientX-s.clientX,2)+Math.pow(o.clientY-s.clientY,2),.5),h=t._softZoom.zoom;h*=c/r,h>t.maxZoom4GestureWheel&&(h=t.maxZoom4GestureWheel),h<1&&(h=1),t.setSoftZoom(h,{center:t._softZoom.center,limit:!0}),t._lastZoomTime=i,t._eventListeners.zoom?.forEach((e=>{try{e(t)}catch(e){console.error(e)}}));break}t._mapZoomTouchs.clear();for(let i of e.touches)t._mapZoomTouchs.set(i.identifier,{x:i.clientX,y:i.clientY})},l._arrConstructors.push((function(){const e=this;e._isFocusing=!1,e._advancedFocusParameters={minFocusDistanceLimit:.01,maxFocusDistanceLimit:10,firstStepWaitDuration:500,coarseStepWaitDuration:350,switchStepWaitDuration:400,fineStepWaitDuration:350,maxStepCount:30,backToContinousDuration:5e3,focusWH:.2,coarseTuneRate:.5,coarseTuneTolerance:.5,fineTuneRate:1.1},e._advancedFocusTaskId=0,e.enableTapToFocus="simple"})),l._getImageContrast=(e,t,i)=>{let o=0;for(let s=0;s<i-1;s++)for(let i=0;i<t-1;i++){const n=4*(s*t+i),a=n+4,r=n+4*t,c=e[n]-e[a],h=e[n+1]-e[a+1],d=e[n+2]-e[a+2],l=e[n]-e[r],u=e[n+1]-e[r+1],p=e[n+2]-e[r+2];o+=c*c+h*h+d*d+l*l+u*u+p*p}return o},l.prototype._simpleFocus=async function(){const e=this;if("opened"!==e.status)throw Error("Camera is not opened");if(e._isFocusing)return;const t=e.currentCamera?.capabilities;let i,o;if(t?.focusMode?.includes("manual"))if(t?.focusMode?.includes("continuous"))i="manual",o="continuous";else{if(!t?.focusMode?.includes("single-shot"))return void e._advancedFocus();i="manual",o="single-shot"}else if(t?.focusMode?.includes("single-shot"))t?.focusMode?.includes("continuous")?(i="continuous",o="single-shot"):(i=null,o="single-shot");else{if(!t?.focusMode?.includes("continuous"))return;i=null,o="continuous"}e._isFocusing=!0;try{i&&("manual"===i?await e.track.applyConstraints({advanced:[{focusMode:"manual",focusDistance:t?.focusDistance?.max||10}]}):await e.track.applyConstraints({advanced:[{focusMode:i}]}),await new Promise((e=>setTimeout(e,500)))),await e.track.applyConstraints({advanced:[{focusMode:o}]}),await new Promise((e=>setTimeout(e,500)))}catch(t){"opened"===e.status&&console.warn("Error while do simple focus",t)}e._isFocusing=!1},l.prototype._advancedFocus=async function(e,t,i){const o=this;if("opened"!==o.status)throw Error("Camera is not opened");if(o._isFocusing)return;const s=o.currentCamera?.capabilities;if(!s?.focusMode?.includes("manual"))return void o._simpleFocus();const n=o._advancedFocusParameters,a=o._video.videoWidth,r=o._video.videoHeight;if(a<2||r<2)return;let c,h=0;e?(e.x=Math.round(e.x),e.y=Math.round(e.y),t||(t=Math.min(a,r)*n.focusWH),t<2&&(t=2),t>a&&(t=a),t=2*Math.round(t/2),i||(i=t),i<2&&(i=2),i>r&&(i=r),i=2*Math.round(i/2),e.x<t/2&&(e.x=t/2),e.x>a-t/2&&(e.x=a-t/2),e.y<i/2&&(e.y=i/2),e.y>r-i/2&&(e.y=r-i/2),h=e.x-t/2,c=e.y-i/2):(t=a,i=r),o._isFocusing=!0;const d=++o._advancedFocusTaskId;let u=s?.focusDistance?.min;(!u||u<n.minFocusDistanceLimit)&&(u=n.minFocusDistanceLimit);let p=s?.focusDistance?.max;(!p||p>n.maxFocusDistanceLimit)&&(p=n.maxFocusDistanceLimit);let g=-1/0,m=-1/0,_=1/0,f=p,y=!1,v=!0;const w=document.createElement("canvas").getContext("2d",{willReadFrequently:!0});let b=0;try{for(;++b<n.maxStepCount;){let e;await o.track.applyConstraints({advanced:[{focusMode:"manual",focusDistance:f}]}),y?v?(v=!1,e=n.switchStepWaitDuration):e=n.fineStepWaitDuration:v?(v=!1,e=n.firstStepWaitDuration):e=n.coarseStepWaitDuration,await new Promise((t=>setTimeout(t,e))),o.getFrame({x:h,y:c,width:t,height:i,reusedContext:w});const s=w.getImageData(0,0,t,i).data,a=l._getImageContrast(s,t,i);if(y){if(a<=g){await o.track.applyConstraints({advanced:[{focusMode:"manual",bestFocusDistance:_}]}),await o.track.applyConstraints({advanced:[{focusMode:"manual",bestFocusDistance:_}]});break}if(p===f)break;g=a,a>m&&(m=a,_=f),f*=n.fineTuneRate,f>p&&(f=p)}else(a<=m*n.coarseTuneTolerance||u===f)&&(y=!0),g=a,a>m&&(m=a,_=f),y?(f=Math.sqrt(f*_),v=!0):(f*=n.coarseTuneRate,f<u&&(f=u))}}catch(e){"opened"===o.status&&console.warn("Error while do advanced focus",e)}o._isFocusing=!1,n.backToContinousDuration>0&&setTimeout((async()=>{if(o._advancedFocusTaskId===d)try{await o.track.applyConstraints({advanced:[{focusMode:"continuous"}]})}catch(e){}}),n.backToContinousDuration)},Object.defineProperty(l.prototype,"enableTapToFocus",{get(){return this._enableTapToFocus},set(e){const t=this;t._enableTapToFocus=e,e?t._tapToFocusListner||(t._tapToFocusListner=async e=>{if(!("opened"!==t.status||!t._enableTapToFocus||!e.isPrimary||e.button||e.altKey||e.ctrlKey||e.shiftKey||e.metaKey||"touch"===e.pointerType&&t.enableGestureZoom&&(await new Promise((e=>setTimeout(e,300))),"opened"!==t.status||!t._enableTapToFocus||t._lastZoomTime>Date.now()-1e3||t._mapZoomTouchs.size>1)))if("experimental-advanced"===t._enableTapToFocus){const[{left:i,top:o},{left:s,top:n}]=t.videoXY2FixedLT([{x:0,y:0},{x:t._video.videoWidth,y:t._video.videoHeight}]);t._advancedFocus({x:(e.clientX-i)/(s-i)*t._video.videoWidth,y:(e.clientY-o)/(n-o)*t._video.videoHeight})}else t._simpleFocus()},t._coreShell.addEventListener("pointerdown",t._tapToFocusListner)):t._tapToFocusListner&&(t._coreShell.removeEventListener("pointerdown",t._tapToFocusListner),t._tapToFocusListner=null)}}),l._arrConstructors.push((function(){this._isTorchOn=!1,this._autoTorchParameters={shortDelay:250,longDelay:1e3,shortLongDelaySwitchCount:10,maxErrorCount:10,grayThreshold:20,maxDarkCount:3}})),l._arrOnClose.push((function(){this._isTorchOn=!1})),Object.defineProperty(l.prototype,"isSupportTorch",{get(){return!!this.currentCamera?.capabilities?.torch}}),Object.defineProperty(l.prototype,"isTorchOn",{get(){return this._isTorchOn}}),l.prototype.turnOnTorch=async function(){const e=this;if("opened"!==e.status)throw Error("Camera is not opened");try{await e.track.applyConstraints({advanced:[{torch:!0}]})}catch(t){throw e._isTorchOn=!1,t}e._isTorchOn=!0},l.prototype.turnOffTorch=async function(){const e=this;if("opened"!==e.status)throw Error("Camera is not opened");await e.track.applyConstraints({advanced:[{torch:!1}]}),e._isTorchOn=!1},l.prototype.turnAutoTorch=function(){const e=this;if("opened"!==e.status)throw Error("Camera is not opened");if(null==e._isTorchOn)return;e._isTorchOn=void 0;const t=e._autoTorchParameters,i=document.createElement("canvas"),o=i.getContext("2d",{willReadFrequently:!0});let s=0,n=0,a=0;(async()=>{for(;null==e._isTorchOn;){try{e.getFrame({reusedContext:o})}catch(i){if("opened"===e.status&&++s<t.maxErrorCount){await new Promise((e=>setTimeout(e,1e3)));continue}e._isTorchOn=!1;break}const r=o.getImageData(0,0,i.width,i.height).data;let c=0;for(let e=0;e<r.length;e+=4)c+=r[e]+r[e+1]+r[e+2];if(c/=r.length/4*3,c<t.grayThreshold&&++n>=t.maxDarkCount){try{await e.turnOnTorch(),e._eventListeners.torchAutoOn?.forEach((t=>{try{t(e)}catch(e){console.error(e)}}))}catch(e){console.warn("Error while do auto torch",e)}break}await new Promise((e=>setTimeout(e,a<t.shortLongDelaySwitchCount?t.shortDelay:t.longDelay))),++a}})()},l._arrConstructors.push((function(){this._shouldCloseWhenHide=!0,this._maxReopenTry4CloseWhenHide=4})),l._arrOnOpen.push((function(){const e=this;e._shouldCloseWhenHide&&(e._closeWhenHideListener||(e._closeWhenHideListener=()=>{e._closeWhenHide()},document.addEventListener("visibilitychange",e._closeWhenHideListener)))})),l._arrOnClose.push((function(){const e=this;e._closeWhenHideListener&&"visible"===document.visibilityState&&(document.removeEventListener("visibilitychange",e._closeWhenHideListener),e._closeWhenHideListener=null)})),Object.defineProperty(l.prototype,"shouldCloseWhenHide",{get(){return this._shouldCloseWhenHide},set(e){const t=this;t._shouldCloseWhenHide=e,"opened"===t.status&&(e?t._closeWhenHideListener||(t._closeWhenHideListener=()=>{t._closeWhenHide()},document.addEventListener("visibilitychange",t._closeWhenHideListener)):t._closeWhenHideListener&&(document.removeEventListener("visibilitychange",t._closeWhenHideListener),t._closeWhenHideListener=null))}}),l.prototype._closeWhenHide=async function(){const e=this;if("hidden"===document.visibilityState)"opened"===e.status&&(e._isOpenBeforeHide=!0,await e.close());else if(e._isOpenBeforeHide){let t=0;for(;t++<e._maxReopenTry4CloseWhenHide&&"visible"===document.visibilityState;){try{await e.open()}catch(e){await new Promise((e=>setTimeout(e,300)));continue}e._isOpenBeforeHide=!1;break}}};class p{_stAudioFree=new Set;_stAudioPlaying=new Set;_timeLastPlay=0;_bWarnedMaxTrack=!1;maxPlayingBeep=16;beepSoundSource="data:audio/mpeg;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4LjI5LjEwMAAAAAAAAAAAAAAA/+M4wAAAAAAAAAAAAEluZm8AAAAPAAAABQAAAkAAgICAgICAgICAgICAgICAgICAgKCgoKCgoKCgoKCgoKCgoKCgoKCgwMDAwMDAwMDAwMDAwMDAwMDAwMDg4ODg4ODg4ODg4ODg4ODg4ODg4P//////////////////////////AAAAAExhdmM1OC41NAAAAAAAAAAAAAAAACQEUQAAAAAAAAJAk0uXRQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA/+MYxAANQAbGeUEQAAHZYZ3fASqD4P5TKBgocg+Bw/8+CAYBA4XB9/4EBAEP4nB9+UOf/6gfUCAIKyjgQ/Kf//wfswAAAwQA/+MYxAYOqrbdkZGQAMA7DJLCsQxNOij///////////+tv///3RWiZGBEhsf/FO/+LoCSFs1dFVS/g8f/4Mhv0nhqAieHleLy/+MYxAYOOrbMAY2gABf/////////////////usPJ66R0wI4boY9/8jQYg//g2SPx1M0N3Z0kVJLIs///Uw4aMyvHJJYmPBYG/+MYxAgPMALBucAQAoGgaBoFQVBUFQWDv6gZBUFQVBUGgaBr5YSgqCoKhIGg7+IQVBUFQVBoGga//SsFSoKnf/iVTEFNRTMu/+MYxAYAAANIAAAAADEwMFVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVV";beep(){if(!this.beepSoundSource)return;let e,t=Date.now();if(!(t-this._timeLastPlay<100)){if(this._timeLastPlay=t,this._stAudioFree.size&&(e=this._stAudioFree.values().next().value,this.beepSoundSource==e.src?(this._stAudioFree.delete(e),e.play()):e=null),!e)if(this._stAudioPlaying.size<this.maxPlayingBeep){e=new Audio(this.beepSoundSource);let t=null,i=()=>{e.removeEventListener("loadedmetadata",i),e.play(),t=setTimeout((()=>{this._stAudioPlaying.delete(e)}),2e3*e.duration)};e.addEventListener("loadedmetadata",i),e.addEventListener("ended",(()=>{null!=t&&(clearTimeout(t),t=null),e.pause(),e.currentTime=0,this._stAudioPlaying.delete(e),this._stAudioFree.add(e)}))}else this._bWarnedMaxTrack||(this._bWarnedMaxTrack=!0,console.warn(`The requested audio tracks exceed ${this.maxPlayingBeep} and will not be played.`));e&&this._stAudioPlaying.add(e)}}}let g;e.Beep=p,e.Camera=l,e.FramePipeline=class{camera;_ctx;_data;_dataTime=-1/0;_x;_y;_w;_h;_type;maxTimeout=500;_pipeTaskId;constructor(e){this.camera=e;const t=document.createElement("canvas");this._ctx=t.getContext("2d",{willReadFrequently:!0})}_getDate(){this.camera.getFrame({x:this._x,y:this._y,width:this._w,height:this._h,reusedContext:this._ctx});const e=this._ctx.getImageData(0,0,this._w,this._h).data;if("rgba"===this._type)return e;const t=new Uint8Array(e.length/4);for(let i=0;i<e.length;i+=4)t[i/4]=.3*e[i]+.59*e[i+1]+.11*e[i+2];return t}getData(e){let{x:t=0,y:i=0,width:o=this.camera._video.videoWidth,height:s=this.camera._video.videoHeight,type:n="rgba"}=e||{};o=Math.round(o+t)-Math.round(t),s=Math.round(s+i)-Math.round(i),t=Math.round(t),i=Math.round(i);const a=t!==this._x||i!==this._y||o!==this._w||s!==this._h||n!==this._type;let r;return a&&(this._x=t,this._y=i,this._w=o,this._h=s,this._type=n),!a&&this._dataTime+this.maxTimeout>Date.now()&&this._data?(r=this._data,this._data=null):r=this._getDate(),this._pipeTaskId||(this._pipeTaskId=setTimeout((()=>{this._pipeTaskId=null,this._data=this._getDate(),this._dataTime=Date.now()}),0)),r}},e.beep=()=>{(g??=new p).beep()},e.stringToHtml=n,e.vibrate=(e=300)=>{if(!navigator?.vibrate)throw new Error("Not supported.");navigator.vibrate(e)}}));
