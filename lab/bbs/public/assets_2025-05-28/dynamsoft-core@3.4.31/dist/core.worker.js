/*!
 * Dynamsoft JavaScript Library
 * @product Dynamsoft Core JS Edition
 * @website https://www.dynamsoft.com
 * @copyright Copyright 2024, Dynamsoft Corporation
 * @author Dynamsoft
 * @version 3.4.31
 * @fileoverview Dynamsoft JavaScript Library for Core
 * More info on Dynamsoft Core JS: https://www.dynamsoft.com/capture-vision/docs/web/programming/javascript/api-reference/core/core-module.html
 */
!function(){"use strict";const e=e=>e&&"object"==typeof e&&"function"==typeof e.then,s=(async()=>{})().constructor;class t extends s{get status(){return this._s}get isPending(){return"pending"===this._s}get isFulfilled(){return"fulfilled"===this._s}get isRejected(){return"rejected"===this._s}get task(){return this._task}set task(t){let a;this._task=t,e(t)?a=t:"function"==typeof t&&(a=new s(t)),a&&(async()=>{try{const e=await a;t===this._task&&this.resolve(e)}catch(e){t===this._task&&this.reject(e)}})()}get isEmpty(){return null==this._task}constructor(s){let t,a;super(((e,s)=>{t=e,a=s})),this._s="pending",this.resolve=s=>{this.isPending&&(e(s)?this.task=s:(this._s="fulfilled",t(s)))},this.reject=e=>{this.isPending&&(this._s="rejected",a(e))},this.task=s}}const a=self,r={};a.coreWorkerVersion="3.4.31",a.versions=r;const n={},o=a.waitAsyncDependency=async e=>{let s="string"==typeof e?[e]:e,a=[];for(let e of s)a.push(n[e]=n[e]||new t);await Promise.all(a)},i=async(e,s)=>{let a,r="string"==typeof e?[e]:e,o=[];for(let e of r){let r;o.push(r=n[e]=n[e]||new t(a=a||s())),r.isEmpty&&(r.task=a=a||s())}await Promise.all(o)},c=[];a.setBufferIntoWasm=(e,s=0,t=0,a=0)=>{t&&(e=a?e.subarray(t,a):e.subarray(t));let r=c[s]=c[s]||{ptr:0,size:0,maxSize:0};return e.length>r.maxSize&&(r.ptr&&m._free(r.ptr),r.ptr=m._malloc(e.length),r.maxSize=e.length),m.HEAPU8.set(e,r.ptr),r.size=e.length,r.ptr};const l={buffer:0,size:0,pos:0,temps:[],needed:0,prepare:function(){if(l.needed){for(let e=0;e<l.temps.length;e++)m._free(l.temps[e]);l.temps.length=0,m._free(l.buffer),l.buffer=0,l.size+=l.needed,l.needed=0}l.buffer||(l.size+=128,l.buffer=m._malloc(l.size)),l.pos=0},alloc:function(e,s){let t,a=s.BYTES_PER_ELEMENT,r=e.length*a;return r=r+7&-8,l.pos+r>=l.size?(l.needed+=r,t=m._malloc(r),l.temps.push(t)):(t=l.buffer+l.pos,l.pos+=r),t},copy:function(e,s,t){switch(t>>>=0,s.BYTES_PER_ELEMENT){case 2:t>>>=1;break;case 4:t>>>=2;break;case 8:t>>>=3}for(let a=0;a<e.length;a++)s[t+a]=e[a]}},p=a.ep=l.prepare;a.bDebug=!1,a.bLog=!1,a.strDomain=void 0;const d=a.es=e=>{let s=intArrayFromString(e),t=l.alloc(s,m.HEAP8);return l.copy(s,m.HEAP8,t),t},m=a.Module={print:e=>{a.bLog&&b(e)},printErr:e=>{a.bLog&&b(e)},locateFile:(e,s)=>["std.wasm","core.wasm"].includes(e)?g[e.split(".")[0]]+e:e},g=a.engineResourcePaths={},_=a.loadCore=async()=>{const e="core";await i(e,(async()=>{let s=a.bLog&&(b(e+" loading..."),Date.now())||0,t=new Promise((t=>{Module.onRuntimeInitialized=()=>{a.bLog&&b(e+" initialized, cost "+(Date.now()-s)+" ms"),t(void 0)}})),r=g.std+"std.js";importScripts(r),await t}))},u=a.loadSideModule=async(e,{js:s,wasm:t})=>{await i(e,(async()=>{await o("core");let t=a.bLog&&(b(e+" loading..."),Date.now())||0;if(s instanceof Array)for(let t of s){let s=g[e]+t;importScripts(s)}else if(s){let s=g[e]+e+".worker.js";importScripts(s)}wasmImports.emscripten_bind_CoreWasm_PreSetModuleExist&&(p(),wasmImports.emscripten_bind_CoreWasm_PreSetModuleExist(d(e.toUpperCase()))),wasmImports.emscripten_bind_CvrWasm_SetModuleExist&&(p(),wasmImports.emscripten_bind_CvrWasm_SetModuleExist(d(e.toUpperCase())));const n=JSON.parse(UTF8ToString(wasmImports.emscripten_bind_CoreWasm_GetModuleVersion_0())),i=a[`${e}WorkerVersion`];r[e]={worker:`${i||"No Worker"}`,wasm:n[e.toUpperCase()]},a.bLog&&b(e+" initialized, cost "+(Date.now()-t)+" ms")}))},h=a.mapController={loadWasm:async(e,s)=>{try{Object.assign(g,e.engineResourcePaths),e.needLoadCore&&(e.bLog&&(a.bLog=!0),e.dm&&(a.strDomain=e.dm),e.bd&&(a.bDebug=!0),await _());for(let s of e.names)await u(s,e.autoResources[s]);if(e.needLoadCore){const e=JSON.parse(UTF8ToString(wasmImports.emscripten_bind_CoreWasm_GetModuleVersion_0()));r.core={worker:a.coreWorkerVersion,wasm:e.CORE}}f(s,{versions:r})}catch(e){console.log(e),y(s,e)}},setBLog:e=>{a.bLog=e.value},setBDebug:e=>{a.bDebug=e.value},getModuleVersion:async(e,s)=>{try{let e=UTF8ToString(wasmImports.emscripten_bind_CoreWasm_GetModuleVersion_0());f(s,{versions:JSON.parse(e)})}catch(e){y(s,e)}},cfd:async(e,s)=>{try{wasmImports.emscripten_bind_CoreWasm_static_CFD_1(e.count),f(s,{})}catch(e){y(s,e)}}};addEventListener("message",(e=>{const s=e.data?e.data:e,t=s.body,a=s.id,r=s.instanceID,n=h[s.type];if(!n)throw new Error("Unmatched task: "+s.type);n(t,a,r)}));const f=a.handleTaskRes=(e,s)=>{postMessage({type:"task",id:e,body:Object.assign({success:!0},s)})},y=a.handleTaskErr=(e,s)=>{postMessage({type:"task",id:e,body:{success:!1,message:(null==s?void 0:s.message)||"No have error message.",stack:a.bDebug&&(null==s?void 0:s.stack)||"No have stack."}})},b=a.log=e=>{postMessage({type:"log",message:e})}}(),Object.assign(mapController,{dps_createInstance:async(e,s)=>{try{let e=await wasmImports.emscripten_bind_DpsWasm_createInstance();handleTaskRes(s,{instanceID:e})}catch(e){handleTaskErr(s,e)}},dps_initCVRSettings:async(e,s,t)=>{let a;try{const r=e.settings;ep(),a=UTF8ToString(wasmImports.emscripten_bind_DpsWasm_initCVRSettings(t,es(r))),handleTaskRes(s,{success:!0,response:a})}catch(e){handleTaskErr(s,e)}},dps_initSettings:async(e,s,t)=>{let a;try{const r=e.settings;ep(),a=UTF8ToString(wasmImports.emscripten_bind_DpsWasm_initSettings(t,es(r))),handleTaskRes(s,{success:!0,response:a})}catch(e){handleTaskErr(s,e)}},dps_setPanoramicBaseImage:async(e,s,t)=>{await checkAndReauth();try{const a=Date.now();ep();let r=UTF8ToString(wasmImports.emscripten_bind_DpsWasm_stitchImage(t,e.bytes.length,setBufferIntoWasm(e.bytes,0),e.width,e.height,e.stride,e.format,0,es(e.templateName)));const n=Date.now()-a;r=JSON.parse(r);for(let e of r.capturedPanoramaArray){let s=e?.image?.bytes;s?.ptr?(s=new Uint8Array(new Uint8Array(HEAP8.buffer,s.ptr,s.length)),e.image.bytes=s):delete e.image}r.timeCost=n,handleTaskRes(s,{success:!0,response:r})}catch(e){handleTaskErr(s,e)}},dps_clean:async(e,s,t)=>{try{await wasmImports.emscripten_bind_DpsWasm_clean(t),handleTaskRes(s)}catch(e){handleTaskErr(s,e)}},dps_deleteInstance:async(e,s,t)=>{try{await wasmImports.emscripten_bind_DpsWasm_deleteInstance(t),handleTaskRes(s)}catch(e){handleTaskErr(s,e)}}});